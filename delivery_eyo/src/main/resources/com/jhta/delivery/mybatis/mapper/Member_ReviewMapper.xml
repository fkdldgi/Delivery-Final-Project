<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mybatis.Member_ReviewMapper">
	<!-- 가게 번호로 가게의 리뷰 리스트 가져오기 -->
	<select id="shopReviewList" parameterType="int" resultType="com.jhta.delivery.vo.ReviewVo">
		select * from review where shop_num=#{shop_num} and ref=0 and lev=0 order by num desc
	</select>
	
	<!-- 리뷰에 대한 이미지 리스트 가져오기 -->
	<select id="reviewImgList" resultType="com.jhta.delivery.vo.Review_ImgVo">
		select * from review_img
	</select>
	
	<!-- 가게번호로 리뷰 리스트 + 회원 정보 가져오기 -->
	<select id="review_member_list" parameterType="int" resultType="hashmap">
	select level,r.num,r.content,r.ref,r.lev,r.step,r.grade,r.regdate,r.review_img_num,r.shop_num,r.member_num,r.owner_num,m.name,m.img,m.gender
		from review r,member m
		where m.num(+)=r.member_num and r.shop_num=#{shop_num}
		start with r.ref=0
		connect by r.ref = prior r.num and r.member_num is null
	</select>
	
	<!-- 가게번호로 리뷰 리스트 + 회원정보 + 사장님 댓글 가져오기 -->
	<select id="reviewAll" parameterType="int" resultType="hashmap">
		select re1.num reviewnum,re1.content membercontent,re1.grade,re1.review_img_num reviewimg,m.name,m.img,re2.content ownercontent,re2.ref
			from review re1,review re2,member m
			where re1.ref=0
			and m.num=re1.member_num
			and re1.shop_num=#{shop_num} 
			and re2.ref != 0
			order by re1.num desc
	</select>
	<!-- 멤버번호로 주문한 가게번호 가져오기 -->
	<select id="getShopByMember" parameterType="int" resultType="hashmap">
		select shop_num from MENU_CATEGORY
		where num in (select menu_category_num from MENU
                        where num in (select menu_num from ORDER_MENU
                                                where order_num in (select num from order_main 
                                                                                where member_num=#{member_num})))
	</select>
	
	<!-- 가게번호와 고객번호로 리뷰여부 판단하기 -->
	<select id="reviewAble" parameterType="hashmap" resultType="com.jhta.delivery.vo.Order_MainVo">
		select * from ORDER_MAIN 
   			where review_status=0 
        		and shop_num=#{shop_num}
        		and member_num=#{member_num}
        		and status='배달완료'
	</select>
	
	<!-- 주문 번호와 고객번호로 고객이 주문한 메뉴 정보(이름) 가져오기,'배달완료',리뷰status=0인 조건 -->
	<select id="getMenuNum" parameterType="hashmap" resultType="com.jhta.delivery.vo.MenuVo">
		select * 
		from MENU
		where num = 
		(select menu_num 
			from ORDER_MENU menu,ORDER_MAIN main 
			where main.review_status=0
            and main.status='배달완료'
            and main.num=MENU.order_num 
			and MAIN.num=#{order_main_num} 
			and MAIN.member_num=#{member_num})
	</select>
	
	<!-- insert 부분 -->
	
	<!-- 리뷰 이미지 넣기 -->
	<insert id="review_imgInsert" parameterType="hashmap">
		insert into REVIEW_IMG values(REVIEW_IMG_SEQ.nextval,#{img_path},#{original_filename},#{save_filename})
	</insert>
	
	<!-- 리뷰 넣기(사진 없을 때) -->
	<insert id="reviewInsertNo" parameterType="hashmap">
		insert into review values(REVIEW_SEQ.nextval,#{content},0,0,0,#{grade},sysdate,0,#{shop_num},#{member_num},#{owner_num})
	</insert>
	
	<!-- 리뷰 넣기(사진 있을 때) -->
	<insert id="reviewInsertYes" parameterType="hashmap">
		insert into review values(REVIEW_SEQ.nextval,#{content},0,0,0,#{grade},sysdate,REVIEW_IMG_SEQ.currval,#{shop_num},#{member_num},#{owner_num})
	</insert>
	
	<!-- 리뷰 작성 후  ORDER_MAIN의 리뷰구분자 수정하기 -->
	<update id="updateReviewStatus" parameterType="int">
		update ORDER_MAIN set review_status=1 where num=#{num}
	</update>
	
	
	<!-- 멤버 번호와  -->
<!-- 고객번호와 가게번호를 받아 리뷰작성 조건 판단하기 --> 
<!-- 	<select id="reviewAble" parameterType="hashmap" resultType="String"> -->
<!-- 		select NVL(count(*),0) chk -->
<!-- 		from ORDER_MAIN,ORDER_TRANSACTION -->
<!-- 		where (select num from ORDER_MAIN where member_num=#{member_num}) in (select order_num from ORDER_TRANSACTION where shop_num=#{shop_num}) -->
<!-- 	</select> -->
	
<!-- 주문한 고객이 리뷰를 썼는지 -->
<!-- 	<select id="selectMemberReview" parameterType="hashmap" resultType="com.jhta.delivery.vo.ReviewVo"> -->
<!-- 		select * from REVIEW where member_num=#{member_num} and shop_num=#{shop_num} -->
<!-- 	</select> -->
</mapper>